<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body { 
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding: 16px; 
        margin: 0;
        box-sizing: border-box; 
        color: #333;
        display: flex; 
        flex-direction: column; 
        height: 100vh;
      }

      /* Label style */
      .input-label {
        font-size: 11px;
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        display: block;
      }

      /* --- Tag Input Container --- */
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px;
        border: 1px solid #e1e1e1;
        border-radius: 6px;
        background: #fff;
        min-height: 80px;
        cursor: text;
        transition: border-color 0.2s;
        align-content: flex-start;
        position: relative;
      }
      .tag-container:focus-within {
        border-color: #18A0FB;
        outline: 2px solid rgba(24, 160, 251, 0.2);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        background: #f0f0f0;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 500;
        color: #333;
        user-select: none;
        transition: all 0.2s ease;
        max-width: 100%;
      }

      /* Status states for tags */
      .tag.loading { background: #e3f2fd; color: #0d47a1; }
      .tag.done { background: #e8f5e9; color: #1b5e20; }
      .tag.error { background: #ffebee; color: #c62828; cursor: help; }
      .tag.skipped { background: #f5f5f5; color: #999; opacity: 0.7; text-decoration: line-through; }

      .tag-icon {
        width: 12px;
        height: 12px;
        margin-right: 6px;
        display: none; 
      }
      
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .icon-spinner {
        border: 2px solid rgba(13, 71, 161, 0.2);
        border-top-color: #0d47a1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .tag.loading .icon-spinner { display: block; }
      .tag.done .icon-check { display: block; }
      .tag.error .icon-x { display: block; }

      #input-field {
        border: none;
        outline: none;
        flex: 1;
        min-width: 60px;
        font-size: 12px;
        padding: 4px 0;
        color: #333;
        font-family: inherit;
        background: transparent;
      }

      /* Clear button inside container */
      #clear-btn {
        position: absolute;
        bottom: 6px;
        right: 8px;
        font-size: 11px;
        color: #999;
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
        padding: 0;
        display: none; 
      }
      #clear-btn:hover { color: #d32f2f; }
      #clear-btn.visible { display: block; }

      /* --- Controls Row --- */
      .controls {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      button#run {
        flex: 1;
        background: #18A0FB;
        color: white;
        border: none;
        border-radius: 6px;
        height: 32px;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button#run:hover { background: #0d8de3; }
      button#run:disabled { background: #ccc; cursor: default; }
      button#run.error-state { background: #e57373; }

      button#setup {
        width: 32px;
        height: 32px;
        background: transparent;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
      }
      button#setup:hover { background: #f5f5f5; color: #333; }
      button#setup svg { width: 16px; height: 16px; }

      /* --- Settings Panel --- */
      #settings-panel {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eee;
        display: none;
        padding-bottom: 12px;
      }
      #settings-panel.visible { display: block; }
      
      .settings-label { font-size: 11px; font-weight: 600; color: #888; margin-bottom: 4px; display: block; }
      #serverBase {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        font-family: "Inter", sans-serif;
        box-sizing: border-box;
      }

      /* Connection Status Indicator - Now at Top */
      .status-header {
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #666;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc; /* Default Gray */
        transition: background 0.3s ease;
      }

      .status-dot.online { background: #00ca51; box-shadow: 0 0 4px #00ca51; }
      .status-dot.offline { background: #f24822; box-shadow: 0 0 4px #f24822; }

      /* Layer Names Container - Grouped UI */
      .layer-names-container {
        background: #f8f9fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
      }

      .layer-names-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
      }

      .layer-names-header svg {
        width: 14px;
        height: 14px;
        color: #666;
      }

      .layer-names-description {
        font-size: 10px;
        color: #6c757d;
        margin-bottom: 14px;
        line-height: 1.4;
      }

      /* Layer Name Input Groups */
      .layer-input-group {
        margin-bottom: 8px;
      }

      .layer-input-group:last-child {
        margin-bottom: 0;
      }

      .layer-label-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .layer-label {
        font-size: 11px;
        font-weight: 500;
        color: #495057;
      }

      /* Toggle Switch - Smaller */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 26px;
        height: 14px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 18px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 10px;
        width: 10px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }

      .toggle-switch input:checked + .toggle-slider {
        background-color: #18A0FB;
      }

      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(12px);
      }

      .toggle-switch input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .layer-input {
        width: 100%;
        padding: 7px 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 11px;
        font-family: "Inter", sans-serif;
        box-sizing: border-box;
        color: #333;
        background: white;
        transition: all 0.2s;
      }

      .layer-input:hover {
        border-color: #adb5bd;
      }

      .layer-input:focus {
        outline: none;
        border-color: #18A0FB;
        box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.1);
      }

      .layer-input::placeholder {
        color: #adb5bd;
        font-style: italic;
      }

      .run-text { margin: 0 4px; }
    </style>
  </head>
  <body>

    <!-- Connection Status at Top -->
    <div class="status-header">
      <div id="status-dot" class="status-dot"></div>
      <span id="status-text">Checking helper tool...</span>
    </div>

    <span class="input-label">Merchant names (comma separated)</span>

    <div class="tag-container" id="tag-wrapper">
      <input id="input-field" placeholder="e.g. Nike, Puma" autocomplete="off" />
      <button id="clear-btn">Clear</button>
    </div>

    <div class="controls">
      <button id="run"><span class="run-text">Run</span></button>
      <button id="setup" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
    </div>

    <div id="settings-panel">
      <!-- Credits -->
      <div style="font-size: 10px; color: #999; margin-bottom: 16px; text-align: center;">
        Made for Affirm by <a href="https://www.anichauhan.com/" target="_blank" style="color: #18A0FB; text-decoration: none;">Ani Chauhan</a>
      </div>

      <!-- Layer Names Section - Grouped UI -->
      <div class="layer-names-container">
        <div class="layer-names-header">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3h7v7H3z"/>
            <path d="M14 3h7v7h-7z"/>
            <path d="M14 14h7v7h-7z"/>
            <path d="M3 14h7v7H3z"/>
          </svg>
          <span class="settings-label" style="margin-bottom: 0;">Layer Names</span>
        </div>
        <div class="layer-names-description">
          Customize which layer names to look for in your cards
        </div>

        <div class="layer-input-group">
          <div class="layer-label-row">
            <label class="layer-label">Name Layer</label>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleName" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <input id="layerName" class="layer-input" placeholder="Merchant name" />
        </div>

        <div class="layer-input-group">
          <div class="layer-label-row">
            <label class="layer-label">Logo Layer</label>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleLogo" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <input id="layerLogo" class="layer-input" placeholder="Logo" />
        </div>

        <div class="layer-input-group">
          <div class="layer-label-row">
            <label class="layer-label">Image Layer</label>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleHero" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <input id="layerHero" class="layer-input" placeholder="Hero" />
        </div>
      </div>

      <!-- Server URL -->
      <div>
        <span class="settings-label">Server URL</span>
        <input id="serverBase" value="http://localhost:8787" placeholder="http://localhost:8787" />
      </div>
    </div>

    <script>
      const tagWrapper = document.getElementById('tag-wrapper');
      const inputField = document.getElementById('input-field');
      const clearBtn = document.getElementById('clear-btn');
      const runBtn = document.getElementById('run');
      const setupBtn = document.getElementById('setup');
      const settingsPanel = document.getElementById('settings-panel');
      const serverBaseEl = document.getElementById('serverBase');
      const runText = runBtn.querySelector('.run-text');

      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');

      // Layer name inputs
      const layerNameEl = document.getElementById('layerName');
      const layerLogoEl = document.getElementById('layerLogo');
      const layerHeroEl = document.getElementById('layerHero');

      // Layer toggles
      const toggleNameEl = document.getElementById('toggleName');
      const toggleLogoEl = document.getElementById('toggleLogo');
      const toggleHeroEl = document.getElementById('toggleHero');

      // Default layer names
      const DEFAULT_LAYER_NAMES = {
        name: 'Merchant name',
        logo: 'Logo',
        hero: 'Hero'
      };

      let tags = [];
      let isRunning = false;
      let isServerOnline = false;

      // --- Heartbeat Logic ---
      async function checkConnection() {
        const serverUrl = serverBaseEl.value.trim() || "http://localhost:8787";
        try {
          const res = await fetch(`${serverUrl}/health`, { method: 'GET', mode: 'cors' });
          if (res.ok) {
            statusDot.className = 'status-dot online';
            statusText.innerHTML = 'Connected to helper tool'; 
            isServerOnline = true;
          } else { throw new Error(); }
        } catch (e) {
          statusDot.className = 'status-dot offline';
          // Link to your site for the download
          statusText.innerHTML = 'Please run helper tool.';
          isServerOnline = false;
        }
      }

      // Check immediately and then every 5 seconds
      checkConnection();
      setInterval(checkConnection, 5000);

      function updateUIState() {
        if (tags.length > 0 && !isRunning) {
          clearBtn.classList.add('visible');
        } else {
          clearBtn.classList.remove('visible');
        }

        if (tags.length > 0 || inputField.value.length > 0) {
          inputField.removeAttribute('placeholder');
        } else {
          inputField.setAttribute('placeholder', 'e.g. Nike, Puma');
        }
      }

      function renderTags() {
        const existingTags = tagWrapper.querySelectorAll('.tag');
        existingTags.forEach(t => t.remove());

        tags.forEach((tagText, index) => {
          const tagEl = document.createElement('div');
          tagEl.className = 'tag';
          tagEl.dataset.index = index;
          tagEl.innerHTML = `
            <div class="tag-icon icon-spinner"></div>
            <svg class="tag-icon icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <svg class="tag-icon icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span>${tagText}</span>
          `;
          tagWrapper.insertBefore(tagEl, inputField);
        });

        updateUIState();
      }

      function addTag(text) {
        const clean = text.replace(/,/g, '').trim();
        if (clean) {
          tags.push(clean);
          renderTags();
        }
        inputField.value = '';
        updateUIState();
      }

      function removeLastTag() {
        if (tags.length > 0) {
          const last = tags.pop();
          renderTags();
          return last;
        }
        return null;
      }

      clearBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        tags = [];
        inputField.value = '';
        renderTags();
        inputField.focus();
      });

      inputField.addEventListener('paste', (e) => {
        if (isRunning) { e.preventDefault(); return; }
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const items = paste.split(',');
        items.forEach(item => {
            if (item.trim()) addTag(item);
        });
      });

      inputField.addEventListener('keydown', (e) => {
        if (isRunning) { e.preventDefault(); return; }
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          addTag(inputField.value);
        } else if (e.key === 'Backspace' && inputField.value === '') {
          e.preventDefault();
          const lastText = removeLastTag();
          if (lastText) {
            inputField.value = lastText;
            updateUIState();
          }
        }
      });

      inputField.addEventListener('input', () => {
        if (inputField.value.startsWith(' ')) {
           inputField.value = inputField.value.trimStart();
        }
        updateUIState();
      });

      inputField.addEventListener('blur', () => {
        if (!isRunning && inputField.value.trim()) {
          addTag(inputField.value);
        }
      });

      tagWrapper.addEventListener('click', (e) => {
        if (e.target === tagWrapper || e.target === inputField) {
           inputField.focus();
        }
      });

      // Load saved settings
      function loadSettings() {
        const saved = localStorage.getItem('merchantAutofillSettings');
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            serverBaseEl.value = settings.serverUrl || 'http://localhost:8787';
            layerNameEl.value = settings.layerNames?.name || '';
            layerLogoEl.value = settings.layerNames?.logo || '';
            layerHeroEl.value = settings.layerNames?.hero || '';

            // Load toggle states (default to true if not saved)
            toggleNameEl.checked = settings.layerToggles?.name !== false;
            toggleLogoEl.checked = settings.layerToggles?.logo !== false;
            toggleHeroEl.checked = settings.layerToggles?.hero !== false;
          } catch (e) {
            console.error('Failed to load settings:', e);
          }
        }

        // Set placeholders to defaults
        layerNameEl.placeholder = DEFAULT_LAYER_NAMES.name;
        layerLogoEl.placeholder = DEFAULT_LAYER_NAMES.logo;
        layerHeroEl.placeholder = DEFAULT_LAYER_NAMES.hero;
      }

      // Save settings
      function saveSettings() {
        const settings = {
          serverUrl: serverBaseEl.value.trim(),
          layerNames: {
            name: layerNameEl.value.trim(),
            logo: layerLogoEl.value.trim(),
            hero: layerHeroEl.value.trim()
          },
          layerToggles: {
            name: toggleNameEl.checked,
            logo: toggleLogoEl.checked,
            hero: toggleHeroEl.checked
          }
        };
        localStorage.setItem('merchantAutofillSettings', JSON.stringify(settings));
      }

      // Auto-save on input and toggle change
      [serverBaseEl, layerNameEl, layerLogoEl, layerHeroEl].forEach(el => {
        el.addEventListener('input', saveSettings);
      });
      [toggleNameEl, toggleLogoEl, toggleHeroEl].forEach(el => {
        el.addEventListener('change', saveSettings);
      });

      // Resize plugin when settings toggle
      setupBtn.addEventListener('click', () => {
        settingsPanel.classList.toggle('visible');
        const isVisible = settingsPanel.classList.contains('visible');

        // Resize the plugin (increased height for better grouped UI)
        parent.postMessage(
          { pluginMessage: { type: "RESIZE", height: isVisible ? 500 : 232 } },
          "*"
        );

        if (isVisible) {
          layerNameEl.focus();
        }
      });

      runBtn.addEventListener('click', () => {
        // SAFETY GUARD: Check connection before proceeding
        if (!isServerOnline) {
          alert("Please run helper tool before running the plugin.");
          return;
        }

        if (inputField.value.trim()) addTag(inputField.value);
        if (tags.length === 0) return;

        // Get layer names (use defaults if empty)
        const layerNames = {
          name: layerNameEl.value.trim() || DEFAULT_LAYER_NAMES.name,
          logo: layerLogoEl.value.trim() || DEFAULT_LAYER_NAMES.logo,
          hero: layerHeroEl.value.trim() || DEFAULT_LAYER_NAMES.hero
        };

        // Get layer toggle states
        const layerToggles = {
          name: toggleNameEl.checked,
          logo: toggleLogoEl.checked,
          hero: toggleHeroEl.checked
        };

        startRun();
        parent.postMessage(
          {
            pluginMessage: {
              type: "RUN",
              merchants: tags,
              serverBase: serverBaseEl.value.trim(),
              layerNames: layerNames,
              layerToggles: layerToggles
            }
          },
          "*"
        );
      });

      function startRun() {
        isRunning = true;
        inputField.disabled = true;
        runBtn.disabled = true;
        clearBtn.classList.remove('visible'); 
        runText.innerText = "Running...";
        runBtn.classList.remove('error-state');
        
        document.querySelectorAll('.tag').forEach(t => {
            t.className = 'tag'; 
            t.removeAttribute('title');
        });
      }

      function finishRun(errorCount) {
        if (errorCount > 0) {
            runText.innerText = `Finished (${errorCount} errors)`;
            runBtn.classList.add('error-state');
        } else {
            runText.innerText = "Finished Populating";
        }
        
        setTimeout(() => {
          isRunning = false;
          inputField.disabled = false;
          runBtn.disabled = false;
          runText.innerText = "Run";
          runBtn.classList.remove('error-state');
          
          document.querySelectorAll('.tag').forEach(t => {
            t.className = 'tag';
            t.removeAttribute('title');
          });
          
          updateUIState();
          inputField.focus();
        }, 2000);
      }

      function updateTagStatus(index, status, errorMsg) {
        const tagEl = tagWrapper.querySelector(`.tag[data-index="${index}"]`);
        if (!tagEl) return;
        tagEl.className = 'tag'; 
        if (status === 'fetching' || status === 'populating') {
          tagEl.classList.add('loading');
        } else if (status === 'done') {
          tagEl.classList.add('done');
        } else if (status === 'error') {
          tagEl.classList.add('error');
          tagEl.title = errorMsg || "Unknown Error"; 
        } else if (status === 'skipped') {
          tagEl.classList.add('skipped');
          tagEl.title = "Skipped (No available card)";
        }
      }

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "STATUS") {
            const map = {
                'FETCH': 'fetching',
                'POPULATE': 'populating',
                'DONE': 'done',
                'ERROR': 'error',
                'SKIPPED': 'skipped'
            };
            updateTagStatus(msg.index, map[msg.code], msg.error);
        }

        if (msg.type === "COMPLETE") {
            finishRun(msg.errorCount || 0);
        }
      };
      
      // Initialize
      loadSettings();
      updateUIState();
    </script>
  </body>
</html>